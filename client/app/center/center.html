<!--    TODO: HAVE 'panel-title-container' in separate template!!   -->
<div class="panel-title-container">
  <!--    STAR ICON -->
  <span class="prefix star" data-ng-click="onStarClick(currentEntity.type, currentEntity.id);">
    <i class="icon-star" ng-class="{'icon-star-fill starred-on' : currentEntity.isStarred}"></i>
  </span>

  <!--    PREFIX ICON -->
  <span class="prefix">
    <i data-ng-if="currentEntity.type === 'channel'" class="icon-topic-fill"></i>
    <i data-ng-if="currentEntity.type === 'privateGroup'" class="icon-chat-fill"></i>
    <i data-ng-if="currentEntity.type === 'user'" class="icon-user"></i>
  </span>

  <!--Title Dropdown-->
  <span class="panel-title-info">

    <!--    TITLE   -->
    <span class="panel-title-info-name-container ng-binding dropdown-toggle header-padding-for-prefix" data-toggle="dropdown">
      <span class="inline-overflow-ellipsis panel-title-info__name">{{ currentEntity | getName }}
        <i class="fa fa-caret-down header-title-info__more"></i>
      </span>
    </span>

    <!--  TOPICS  -->
    <ul class="dropdown-menu grey_dropdown header-title-info__dropdown" role="menu" data-ng-if="currentEntity.type === 'channels' || currentEntity.type === 'privategroups'">
      <!--    INVITE  -->
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-ng-click="openModal('invite')">
          <i class="icon-invite-fill"></i><span translate>@ch-menu-invite</span>
        </a>
      </li>

      <!--    STAR    -->
      <li role="presentation" data-ng-click="onStarClick(currentEntity.type, currentEntity.id)">
        <a role="menuitem" tabindex="-1">
          <i ng-if="currentEntity.isStarred" class="icon-star"></i><span ng-if="currentEntity.isStarred" translate>@ch-menu-un-star</span>
          <i ng-if="!currentEntity.isStarred" class="icon-star-fill"></i><span ng-if="!currentEntity.isStarred" translate>@ch-menu-star</span>
        </a>
      </li>

      <!--    RENAME  -->
      <li role="presentation" data-ng-if="isOwner();" data-ng-click="openModal('rename')">
        <a role="menuitem" tabindex="-1">
          <i class="icon-edit-fill"></i><span translate>@ch-menu-rename</span>
        </a>
      </li>

      <!--    LEAVE   -->
      <li role="presentation" data-ng-click="onLeaveClick();" data-ng-if="!isDefaultTopic();">
        <a role="menuitem" tabindex="-1">
          <i class="icon-logout"></i><span translate>@ch-menu-leave</span>
        </a>
      </li>

      <!--    DELETE  -->
      <li role="presentation" data-ng-if="isOwner() && !isDefaultTopic()" data-ng-click="onDeleteClick();">
        <a role="menuitem" tabindex="-1">
          <i class=" icon-delete-circle-fill "></i><span translate>@ch-menu-delete</span>
        </a>
      </li>
    </ul>

    <!--User-->
    <ul class="dropdown-menu grey_dropdown header-title-info__dropdown" data-ng-if="currentEntity.type === 'users'">

      <!--    INVITE  -->
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-ng-click="openModal('inviteUserToChannel')">
          <i class="icon-invite-fill"></i><span translate>@dm-menu-invite</span>
        </a>
      </li>

      <!--    STAR    -->
      <li role="presentation" data-ng-click="onStarClick(currentEntity.type, currentEntity.id)">
        <a role="menuitem" tabindex="-1">
          <i ng-if="currentEntity.isStarred" class="icon-star"></i><span ng-if="currentEntity.isStarred" translate>@user-menu-un-star</span>
          <i ng-if="!currentEntity.isStarred" class="icon-star-fill"></i><span ng-if="!currentEntity.isStarred" translate>@user-menu-star</span>
        </a>
      </li>

      <!--    VIEW USER PROFILE   -->
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-ng-click="onUserClick(currentEntity.id);">
          <i class="icon-user2"></i><span translate>@dm-menu-profile</span>
        </a>
      </li>

      <!--    VIEW USER FILE LIST -->
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-ng-click="onFileListClick(currentEntity.id);">
          <i class="icon-file"></i><span translate>@dm-menu-file</span>
        </a>
      </li>

      <!--    LEAVE CHAT -->
      <li role="presentation">
        <a role="menuitem" tabindex="-1" data-ng-click="onMeesageLeaveClick(currentEntity.id);">
          <i class="icon-cancel"></i><span translate>@common-conversation-leave</span>
        </a>
      </li>


    </ul>

  </span>

  <!--Member Dropdown-->
  <span class="panel-title-member">
    <span class="dropdown-toggle panel-title-member__more" data-toggle="dropdown" data-ng-if="currentEntity.type != 'users'">
      <i class="icon-user"></i> <span>{{ currentEntity.ch_members.length || currentEntity.pg_members.length }}</span>
    </span>
    <ul class="dropdown-menu grey_dropdown header-title-member__dropdown" role="menu">
      <li role="presentation" tabindex="-1" data-ng-repeat="userId in currentEntity.ch_members || currentEntity.pg_members track by userId">
        <a data-ng-if="userId == member.id">
          <i class="icon-user2"></i>
          {{ member | getName }}
        </a>
        <a data-ng-if="userId != member.id" data-ui-sref="archives({entityType:'users', entityId:userId})">
          <i class="icon-user2"></i>
          {{ userId | getName }}
        </a>
      </li>
    </ul>
  </span>

</div>

<!--    WRAPPING DIV FOR FILE DRAG&DROP -->
<div ng-file-drop="onFileSelect($files);" drag-over-class="dnd-hover" hide-on-drop-not-available="false">
  <div class="dnd-hover-msg" >
    <span translate>@dnd-file-upload-msg</span>
    <div class="background"></div>
  </div>

  <div class="file-upload-progress-container" ng-if="curUpload.status != null" ng-class="{'isAborted':curUpload.isAborted || curUpload.hasError}">
    <!--    'uploading'     -->
    <span translate ng-if="curUpload.status == 'uploading'">@common-file-upload-progress-msg</span>
    <!--    'aborted'       -->
    <span translate ng-if="curUpload.isAborted">@common-file-upload-abort-msg</span>
    <!--    'done'      -->
    <span translate ng-if="curUpload.status == 'done'">@common-file-upload-done-msg</span>
    <!--    'error'     -->
    <span translate ng-if="curUpload.status == 'error'">@common-api-error-msg</span>


    <!--    file title  -->
    <span class="file-upload-progress-title">[{{curUpload.title}}]</span>
    <!--    progress in percentile  -->
    <span class="file-upload-progress-completion-percent">{{curUpload.progress}}%</span>
    <!--    'cancel'    -->
    <span class="file-upload-progress-abort pull-right cursor_pointer" ng-click="onFileUploadAbortClick();" data-ng-if="curUpload.status=='uploading'">cancel</span>
    <!--    'x' icon    -->
    <span class="file-upload-progress-icon-cancel pull-right cursor_pointer" data-ng-click="onFileIconCloseClick();" data-ng-if="curUpload.status!='uploading'"><i class="icon-cancel"></i></span>

    <!--<div class="file-upload-progress-bar" style="width:{{curUpload.progress}}%;"></div>-->
    <progressbar class="progress-striped jandi-file-upload-progress-bar active" max="100" value="curUpload.progress" ng-class="{'remove-animation':curUpload.progress == 100}"></progressbar>

  </div>


  <div class="file-upload-progress-container isAborted" ng-if="true" ng-class="{'isAborted':curUpload.isAborted || curUpload.hasError}" style="top: 70px;">
    <!--    'uploading'     -->
    <span translate ng-if="curUpload.status == 'uploading'">@common-file-upload-progress-msg</span>
    <!--    'aborted'       -->
    <span translate ng-if="curUpload.isAborted">@common-file-upload-abort-msg</span>
    <!--    'done'      -->
    <span translate ng-if="curUpload.status == 'done'">@common-file-upload-done-msg</span>
    <!--    'error'     -->
    <span translate ng-if="curUpload.status == 'error'">@common-api-error-msg</span>


    <!--    file title  -->
    <span class="file-upload-progress-title">[{{curUpload.title}}]</span>
    <!--    progress in percentile  -->
    <span class="file-upload-progress-completion-percent">{{curUpload.progress}}%</span>
    <!--    'cancel'    -->
    <span class="file-upload-progress-abort pull-right cursor_pointer" ng-click="onFileUploadAbortClick();" data-ng-if="curUpload.status=='uploading'">cancel</span>
    <!--    'x' icon    -->
    <span class="file-upload-progress-icon-cancel pull-right cursor_pointer" data-ng-click="onFileIconCloseClick();" data-ng-if="curUpload.status!='uploading'"><i class="icon-cancel"></i></span>

    <!--<progressbar class="progress-striped active" max="100" value="curUpload.progress" ></progressbar>-->
    <progressbar class="progress-striped active jandi-file-upload-progress-bar remove-animation" max="100" value="80" ></progressbar>
  </div>


  <article class="msgs" when-scrolled="loadMore()"  scroll-bottom-on="msgLoadStatus.loaded" scroll-glue>

    <div class="msgs__loading icon-loading" data-ng-show="msgLoadStatus.loading || msgLoadStatus.loadingTimer" data-ng-class="{'initial': (!msgLoadStatus.isInitialLoadingCompleted)}"></div>

    <div class="msgs-holder" data-ng-show="!msgLoadStatus.loading && !msgLoadStatus.loadingTimer || msgLoadStatus.isInitialLoadingCompleted">

      <div class="msgs-group" data-ng-repeat="(day, msgs) in groupMsgs">

        <div class="msgs-group__divider">
          {{ day.substr(8) }}
        </div>

        <div last-detector=""
             data-length="{{msgs.length}}"
             class="msg-item"
             data-ng-repeat="msg in msgs  | orderBy: 'time':false"
             data-link-id="msg.id"
             data-link-status="msg.status"
             data-message-id="msg.message.id"
             data-message-type="msg.message.contentType"
             data-feedback-id="msg.feedbackId"
             data-event-type="msg.eventType"
             data-ng-class="{   'text': msg.message.isText, 'file-upload': msg.message.isFile,
                                    'comment-title': msg.message.commentOption.isTitle,
                                    'comment-continue': msg.message.commentOption.isContinue,
                                    'system-event-msg' : msg.message.contentType === 'systemEvent' }">

          <div class="msg-item-float cursor_pointer" data-ng-if="( !msg.message.commentOption.isContinue )" data-ng-click="onUserClick(msg.fromEntity);"
               ng-switch="msg.message.contentType">

            <!--    SYSTEM EVENT    -->
            <img class="user-profile user-thumb" ng-switch-when="systemEvent"/>

            <!--    FILE    -->
            <img on-image-load class="user-profile user-thumb" ng-switch-when="file"
                 ng-src="{{ msg.fromEntity | getSmallThumbnail }}"/>

            <!--    DEFAULT   -->
            <img on-image-load class="user-profile user-thumb" ng-switch-default
                 ng-src="{{ msg.message.writer | getSmallThumbnail }}"/>
          </div>

          <!--    HEADER PART -->
          <!--    DISPLAYS WRITER WHEN IT IS NOT TITLE COMMENT    -->
          <!--    WHEN IT IS TITLE COMMENT, APPLIES DIFFERENT CSS FORMAT  -->
          <div class="msg-item-header">
            <!--    WRITER
                    IF IT IS TITLE COMMENT, HIDE WRITER NAME FROM HEADER    -->
            <span class="msg-item-header__name cursor_pointer" data-ng-click="onUserClick(msg.fromEntity);"
                  ng-hide="!msg.message.commentOption.isTitle && msg.message.contentType === 'comment'">
              <span ng-if="msg.message.contentType !== 'file'"> {{msg.message.writer|getName}} </span>
              <span ng-if="msg.message.contentType === 'file'"> {{msg.fromEntity|getName}} </span>

              <!--    CREATED TIME    -->
              <span class="msg-item-header__created">
                {{msg.time | date: 'h:mm a'}}
              </span>

            </span>

            <!--    CONTINUED COMMENT ON SAME FILE  -->
            <span class="continue-comment-body" ng-if="!msg.message.commentOption.isTitle && msg.message.contentType === 'comment'">
              <!--    COMMENT CONTENT -->
              <p >
                <!--    WRITER  -->
                <span class="msg-item-header__name cursor_pointer" data-ng-click="onUserClick(msg.fromEntity);">
                  <span ng-if="msg.message.contentType !== 'file'"> {{msg.message.writer|getName}} </span>
                  <span ng-if="msg.message.contentType === 'file'"> {{msg.fromEntity|getName}} </span>
                </span>

                <!--    CONTENT(MESSAGE)    -->
                <span class="keep" data-ng-bind-html="(msg.message.content.body) || ''"></span>

                <!--    CREATED TIME    -->
                <span class="msg-item-header__created">
                  {{msg.time | date: 'h:mm a'}}
                </span>
              </p>
            </span>

            <!--    DELETE ICON APPEARS ON HOVER    -->
            <a class="msg-item__action link-remove pull-right cursor_pointer"
               data-ng-if="( member.id === msg.fromEntity.id &&  msg.message.contentType === 'text' )"
               data-ng-click="deleteMessage(msg)"
               tooltip="{{ '@message-delete' | translate }}">
              <i class="icon-cancel"></i>
            </a>
          </div>

          <div class="msg-item-body">

            <!-- TEXT -->
            <div class="msg-text" data-ng-if="msg.message.contentType === 'text'">
              <p class="msg-text-body keep" data-ng-bind-html="(msg.message.content.body) || ''"></p>
            </div>

            <!-- FILE -->
            <div class="msg-file" data-ng-if="msg.message.contentType === 'file'">

              <div class="msg-file-body-float pull-left cursor_pointer" data-ng-click="onSmallThumbnailClick($event, msg);">

                <!--    IMAGE THUMBNAIL -->
                <div class="image_wrapper">
                  <img rotate rotate-left-align="true"
                       class="msg-file-body__img cursor_pointer"
                       data-ng-show="(msg.message.content.type).indexOf('image') !== -1"
                       data-ng-src="{{ server_uploaded+msg.message.content.extraInfo.smallThumbnailUrl }}"
                    />
                </div>

                <div ng-if="(msg.message.content.type).indexOf('image') !== -1 &&  isIE9" class="ie9-image-rotator cursor_pointer"
                     ng-click="onImageRotatorClick($event);">
                  <i id="fromCenterLargeThumbnail" class="fa fa-rotate-right"></i>
                </div>

                <!--    FILE TYPE THUMBNAIL -->
                <div class="msg-file-body__thumbnail"
                     data-ng-if="(msg.message.content.type).indexOf('image') == -1">
                  <img class="fileicon" ng-src="assets/images/fileicon_{{msg.message.content.type | getFileIconImage | lowercase}}.png"/>

                </div>

              </div>

              <div class="msg-file-meta">

                <div class="msg-file-meta-up">
                  <!--    TITLE   -->
                  <a class="msg-file-meta__title file__name"
                     data-ui-sref="files({ userName: msg.message.writer.name, itemId: msg.message.id })">
                    {{ msg.message.content.title }}
                  </a>

                  <span class="bullet">•</span>

                  <!--    SIZE AND FILE TYPE  -->
                  <span class="msg-file-meta-info">
                    {{msg.message.content.size | bytes }} {{ msg.message.content.type | filetype }}
                  </span>
                </div>

                <div class="msg-file-meta-down">
                  <!--    SHARED MESSAGE  -->
                  <span class="msg-file-meta-info">
                    <span data-ng-if="( msg.fromEntity.id !== msg.message.writer.id )">
                      <a class="msg-file-meta__writer file__owner">{{msg.message.writer|getName}}</a>
                      <span translate>@msg-whose</span>
                    </span>
                    <span ng-if="msg.status == 'shared'" translate>@msg-shared</span>
                    <span ng-if="msg.status == 'unshared'" translate>@msg-unshared</span>
                    <span translate>@msg-file</span>
                  </span>

                  <span class="bullet">•</span>

                  <!--    SHARED ENTITIES -->
                  <span data-ng-if="msg.message.shared.length">
                    <span data-ng-repeat="sharedEntity in filteredSharedFile = (msg.message.shared | filter: {type:'!user'}) track by $index">
                      <span data-ng-hide="($index === 0)">, </span>
                      <span class="file-item-meta__shared cursor_pointer" data-ng-click="onClickSharedEntity(sharedEntity.id)">
                        {{ sharedEntity.prefix }}{{ sharedEntity.name }}
                      </span>
                      <a class="link-remove link-unshare cursor_pointer" data-ng-click="onClickUnshare(msg.message, sharedEntity)">
                        <i class="fa fa-minus-circle"></i>
                      </a>
                    </span>
                    <span ng-show="msg.message.shared.length != filteredSharedFile.length">
                      <span ng-show="filteredSharedFile.length != 0"> and </span>with users
                    </span>
                    <span class="bullet">•</span>
                  </span>

                  <!-- OPEN ORIGINAL  -->
                  <a class="cursor_pointer" href="{{ server_uploaded + msg.message.content.fileUrl }}" target="{{ server_uploaded + msg.message.content.fileUrl }}">
                    <span translate>@msg-open-original</span>
                  </a>

                  <span class="bullet">•</span>

                  <!--    DOWNLOAD    -->
                  <a class="cursor_pointer" href="{{ server_uploaded +'download/' + msg.message.content.fileUrl }}" download="{{ msg.message.content.title  }}">
                    <span translate>@common-download</span>
                  </a>

                  <span class="bullet">•</span>

                  <!--    COMMENT -->
                  <a class="cursor_pointer"  data-ng-click="setCommentFocus(msg.message);">
                    <span translate>@btn-comment</span>
                  </a>

                  <span class="bullet">•</span>

                  <!--    SHARE   -->
                  <a class="cursor_pointer" data-ng-click="onShareClick(msg.message);">
                    <span translate>@btn-share</span>
                  </a>


                </div>
              </div>
            </div>

            <!--    COMMENT
                    최초 댓글
                    DISPLAY COMMENT BODY WHEN IT IS TITLE
                    IF CURRENT COMMENT IS NOT TITLE, CONTENT GETS DISPLAYED WITHIN HEADER -->
            <div class="msg-comment" data-ng-if="msg.message.contentType === 'comment' && msg.message.commentOption.isTitle" ng-class="{'msg-comment-with-thumbnail': msg.message.commentOption.isTitle}">

              <!--    LEFT PART OF BODY CONTENT
                      IMAGE/FILE THUMBNAIL    -->
              <div class="msg-file-body-float pull-left cursor_pointer"
                   data-ng-click="onSmallThumbnailClick($event, msg);">

                <!--    IMAGE THUMBNAIL -->
                <div class="image_wrapper">
                  <img rotate rotate-left-align="true"
                       class="msg-file-body__img cursor_pointer"
                       data-ng-show="(msg.feedback.content.type).indexOf('image') !== -1 && msg.message.commentOption.isTitle"
                       data-ng-src="{{ server_uploaded+msg.feedback.content.extraInfo.smallThumbnailUrl }}"/>
                </div>

                <!--    FILE THUMBNAIL  -->
                <div class="msg-file-body__thumbnail"
                     data-ng-if="(msg.feedback.content.type).indexOf('image') == -1 && msg.message.commentOption.isTitle">
                  <img class="fileicon" ng-src="assets/images/fileicon_{{msg.feedback.content.type | getFileIconImage | lowercase}}.png"/>

                </div>

                <!--    COMMENT ICON    -->
                <i class="fa fa-comment"></i>

              </div>

              <!--    RIGHT PART OF BODY CONTENT  -->
              <div class="msg-file-meta">
                <div class="msg-comment-header" data-ng-if="( msg.message.commentOption.isTitle )">
                  Commented on
                  <!--    FILE TITLE/NAME  -->
                  <a class="msg-file-meta__title file__name" ui-sref="files({ userName: msg.feedback.writer.name, itemId: msg.feedback.id })">
                    {{msg.feedback.content.title || msg.feedback.content.name}}
                  </a>
                </div>
              </div>

              <!--    COMMENT MESSAGE -->
              <div class="msg-comment-body">

                <p>
                  <!--    WRITER  -->
                  <span class="msg-item-header__name cursor_pointer" data-ng-click="onUserClick(msg.fromEntity);">
                    <span ng-if="msg.message.contentType !== 'file'"> {{msg.message.writer|getName}} </span>
                    <span ng-if="msg.message.contentType === 'file'"> {{msg.fromEntity|getName}} </span>
                  </span>

                  <span class="keep" data-ng-bind-html="(msg.message.content.body) || ''"></span>

                  <span class="msg-item-header__created">
                    {{msg.time | date: 'h:mm a'}}
                  </span>

                </p>

              </div>

            </div>

            <!-- SYSTEM EVENT -->
            <div class="msg-text" data-ng-if="msg.message.contentType === 'systemEvent'">
              <div class="msg-comment-header" data-ng-switch="msg.info.eventType">
                <span data-ng-switch-default>
                  <span class="msg-comment_userType">{{msg.message.content.actionOwner}}</span>
                  <span class="keep" data-ng-bind-html="(msg.message.content.body) || ''"></span>
                </span>
                <span data-ng-switch-when="invite">
                  <span class="msg-comment_userType">{{msg.message.content.actionOwner}}</span>
                  <span class="keep" data-ng-bind-html="(msg.message.content.body) || ''"></span>
                  <span class="msg-comment_userType" data-ng-repeat="invitees in msg.message.invites">
                    <span>{{invitees | getName}}<span data-ng-if="!$last">, </span></span>
                  </span>
                  <span data-ng-if="preferences.language === 'ko'">{{ '@msg-invited-postfix' | translate }}</span>
                </span>
                <span data-ng-if="false"
                      data-msg-join="{{ '@msg-joined' | translate}}"
                      data-msg-leave="{{ '@msg-left' | translate }}"
                      data-msg-invite="{{ '@msg-invited' | translate }}"
                      data-msg-create-channel="{{ '@msg-create-ch' | translate }}"
                      data-msg-create-group="{{ '@msg-create-pg' | translate }}"></span>

                <span class="msg-item-header__created">{{msg.time | date: 'h:mm a'}}</span>

              </div>


            </div>

          </div>
        </div>

      </div>

      <div class="hidden post-message msgs__loading icon-loading" data-ng-if="isPosting"></div>

    </div>

  </article>

  <div class="footer">
    <div class="tutorial-clicker tutorial-z-index pulse" id="chatTutorial"
         data-ng-click="onTutorialPulseClick($event);"
         data-ng-if="!tutorialStatus.chatTutorial"></div>
    <!--<div class="post-message msgs__loading" data-ng-if="isPosting"></div>-->

    <span id="primary_file_button" class="file_upload_btn cursor_pointer" style="height: 35px;">
      <i class="icon-upload"></i>
      <input type="file"
             id="btn-upload-primary"
             class="file_list_button curosr_pointer"
             onclick="this.value=null"
             ng-file-select="onFileSelect($files);"
             value="Upload File">
    </span>

    <div id="messages-input-container" style="height: 35px;">
      <form id="message-form" style="height: 35px;">
        <textarea id="message-input"
                  class=""
                  ng-class="{'post-loading': isPosting}"
                  message-submit="postMessage()"
                  data-ng-disabled="msgLoadStatus.loading"
                  data-ng-model="message.content"
                  maxlength=""
                  style="overflow-y: hidden; height: 35px;"
                  autocorrect="off"
                  autocomplete="off"
                  spellcheck="true"
                  msd-elastic>
        </textarea>
      </form>
    </div>
  </div>
</div>

<div ng-if="false">
  <span translate>@web-notification-title</span>
  <span translate>@web-notification-body-messages-pre</span>
  <span translate>@web-notification-body-messages-post</span>
  <span translate>@web-notification-body-topic-pre</span>
  <span translate>@web-notification-body-topic-mid</span>
  <span translate>@web-notification-body-topic-post</span>
</div>